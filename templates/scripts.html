<script>
const API = location.origin;
let plantChart; 

function initChart() {
  const ctx = document.getElementById('plantChart').getContext('2d');
  plantChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Soil Moisture (%)',
        data: [],
        borderColor: '#B5EAD7',
        backgroundColor: 'rgba(181, 234, 215, 0.4)',
        tension: 0.4,
        fill: true,
        pointRadius: 4
      }, {
        label: 'Temperature (Â°C)',
        data: [],
        borderColor: '#FFB7B2',
        backgroundColor: 'transparent',
        borderDash: [5, 5],
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

async function loadData() {
  const res = await fetch(`${API}/get-data`);
  const data = await res.json();

  document.getElementById("temp").innerText = data.sensor.temperature;
  document.getElementById("hum").innerText = data.sensor.humidity;
  document.getElementById("moist").innerText = data.sensor.moisture;
  
  const moodMap = {
    "HAPPY": "ðŸ˜Š Happy",
    "SAD": "ðŸ˜¢ Thirsty",
    "SLEEPY": "ðŸ˜´ Sleepy",
    "EXCITED": "ðŸ¤© Excited"
  };
  document.getElementById("mood").innerText = moodMap[data.sensor.mood] || data.sensor.mood;

  const taskBox = document.getElementById("tasks");
  taskBox.innerHTML = "";
  data.tasks.forEach(t => {
    const div = document.createElement("div");
    div.className = "task-item" + (t.done ? " done" : "");
    div.innerHTML = `
      <span>${t.title}</span>
      <button class="check-btn" onclick="toggleTask('${t._id}')">âœ“</button>
    `;
    taskBox.appendChild(div);
  });
}

async function updateChart() {
  const res = await fetch(`${API}/get-history`);
  const history = await res.json();

  if (!plantChart) return;

  const labels = history.map(d => {
    const date = new Date(d.timestamp);
    return `${date.getHours()}:${date.getMinutes()}`;
  });
  const moistData = history.map(d => d.moisture);
  const tempData = history.map(d => d.temperature);

  plantChart.data.labels = labels;
  plantChart.data.datasets[0].data = moistData;
  plantChart.data.datasets[1].data = tempData;
  plantChart.update();
}

async function addTask() {
  const title = document.getElementById("taskInput").value;
  if (!title) return;
  await fetch(`${API}/add-task`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({title})
  });
  document.getElementById("taskInput").value = "";
  loadData();
}

async function toggleTask(id) {
  await fetch(`${API}/toggle-task/${id}`, {method: "POST"});
  loadData();
}

initChart();
loadData();
updateChart();
setInterval(loadData, 3000); 
setInterval(updateChart, 10000); 
</script>