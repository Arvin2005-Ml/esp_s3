<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/app.js"></script>
<script>
  async function loadData() {
    try {
      const res = await fetch("/get-data");
      const data = await res.json();
      const s = data.sensor;

      document.getElementById("temperature").textContent = s.temperature;
      document.getElementById("humidity").textContent = s.humidity;
      document.getElementById("moisture").textContent = s.moisture;
      document.getElementById("light").textContent = s.light;
      document.getElementById("gas").textContent = s.gas;
      document.getElementById("water_level").textContent = s.water_level;
      document.getElementById("touch").textContent = s.touch;
      document.getElementById("pump_state").textContent = s.pump_state;
      document.getElementById("mood").textContent = s.mood;

      const pumpStatus = document.getElementById("pump_status");
      if (s.pump_state) {
        pumpStatus.textContent = "روشن";
        pumpStatus.className = "status ok";
      } else {
        pumpStatus.textContent = "خاموش";
        pumpStatus.className = "status bad";
      }

      const tasksList = document.getElementById("tasks_list");
      tasksList.innerHTML = "";
      data.tasks.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t.title;
        if (t.done) li.classList.add("done");
        tasksList.appendChild(li);
      });

      document.getElementById("last_update").textContent = new Date().toLocaleString("fa-IR");
    } catch (e) {
      console.error("Fetch error:", e);
    }
  }

  async function loadHistory() {
    try {
      const res = await fetch("/get-history");
      const hist = await res.json();
      const area = document.getElementById("chart_area");
      area.textContent = "داده دریافت شد: " + hist.length + " رکورد";
    } catch (e) {
      console.error("History error:", e);
    }
  }

  loadData();
  loadHistory();
  setInterval(loadData, 5000);

async function refreshData() {
  const res = await fetch("/get-data");
  const data = await res.json();

  // سنسورها (اگر قبلا داری، همین‌ها را نگه دار)
  if (data.latest) {
    // اینجا کد قبلی خودت برای سنسورها بماند
  }

  // وضعیت پمپ
  const pumpState = data.pump_state === true;
  const stateEl = document.getElementById("pumpState");
  const btn = document.getElementById("pumpToggle");
  if (stateEl) stateEl.textContent = pumpState ? "روشن" : "خاموش";
  if (btn) btn.textContent = pumpState ? "خاموش کردن" : "روشن کردن";
}

async function togglePump() {
  const stateEl = document.getElementById("pumpState");
  const turnOn = stateEl && stateEl.textContent !== "روشن";

  await fetch("/set-pump", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ pump_state: turnOn })
  });

  refreshData();
}

setInterval(refreshData, 5000);
refreshData();

const btn = document.getElementById("pumpToggle");
if (btn) btn.addEventListener("click", togglePump);
</script>
</body>
</html>
