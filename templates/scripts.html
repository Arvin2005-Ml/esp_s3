<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/app.js"></script>
<script>
  // تابع اصلی برای به‌روزرسانی تمام بخش‌های دشبورد
  async function updateDashboard() {
    try {
      const res = await fetch("/get-data");
      const data = await res.json();

      // ۱. به‌روزرسانی مقادیر سنسورها (مستقیم از دیتا خوانده می‌شود)
      // اگر آی‌دی‌ها در HTML شما متفاوت است، آن‌ها را چک کنید
      if (document.getElementById("temperature")) 
          document.getElementById("temperature").textContent = data.temperature || 0;
      
      if (document.getElementById("humidity")) 
          document.getElementById("humidity").textContent = data.humidity || 0;
      
      if (document.getElementById("moisture")) 
          document.getElementById("moisture").textContent = data.moisture || 0;
      
      if (document.getElementById("light")) 
          document.getElementById("light").textContent = data.light || 0;
      
      if (document.getElementById("gas")) 
          document.getElementById("gas").textContent = data.gas || 0;
      
      if (document.getElementById("water_level")) 
          document.getElementById("water_level").textContent = data.water_level || 0;
      
      if (document.getElementById("touch")) 
          document.getElementById("touch").textContent = data.touch || 0;
      
      if (document.getElementById("mood")) 
          document.getElementById("mood").textContent = data.mood || "Unknown";

      // ۲. به‌روزرسانی وضعیت پمپ
      const pumpStatus = document.getElementById("pump_status");
      const pumpStateText = document.getElementById("pumpState"); // برای بخش کنترل پمپ
      const pumpBtn = document.getElementById("pumpToggle");

      const isPumpOn = data.pump_state === true || data.pump_state === 1;

      if (pumpStatus) {
        pumpStatus.textContent = isPumpOn ? "روشن" : "خاموش";
        pumpStatus.className = isPumpOn ? "status ok" : "status bad";
      }

      if (pumpStateText) {
        pumpStateText.textContent = isPumpOn ? "روشن" : "خاموش";
      }

      if (pumpBtn) {
        pumpBtn.textContent = isPumpOn ? "خاموش کردن" : "روشن کردن";
      }

      // ۳. به‌روزرسانی لیست تسک‌ها (اگر در JSON وجود داشته باشد)
      if (data.tasks) {
        const tasksList = document.getElementById("tasks_list");
        if (tasksList) {
          tasksList.innerHTML = "";
          data.tasks.forEach(t => {
            const li = document.createElement("li");
            li.textContent = t.title;
            if (t.done) li.classList.add("done");
            tasksList.appendChild(li);
          });
        }
      }

      // ۴. زمان آخرین بروزرسانی
      if (document.getElementById("last_update")) {
        document.getElementById("last_update").textContent = new Date().toLocaleString("fa-IR");
      }

    } catch (e) {
      console.error("Error fetching dashboard data:", e);
    }
  }

  // تابع تغییر وضعیت پمپ
  async function togglePump() {
    const stateText = document.getElementById("pumpState");
    // اگر متن فعلی "روشن" نیست، پس می‌خواهیم روشن کنیم
    const shouldTurnOn = stateText && stateText.textContent !== "روشن";

    try {
      const response = await fetch("/set-pump", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ pump_state: shouldTurnOn })
      });
      
      if (response.ok) {
        // بلافاصله بعد از دستور، دیتای جدید را بگیر
        setTimeout(updateDashboard, 500); 
      }
    } catch (e) {
      console.error("Error toggling pump:", e);
    }
  }

  // تابع تاریخچه (چارت)
  async function loadHistory() {
    try {
      const res = await fetch("/get-history");
      const hist = await res.json();
      const area = document.getElementById("chart_area");
      if (area) {
        area.textContent = "داده دریافت شد: " + hist.length + " رکورد";
      }
    } catch (e) {
      console.error("History error:", e);
    }
  }

  // اجرای توابع در هنگام لود صفحه
  document.addEventListener("DOMContentLoaded", () => {
    updateDashboard();
    loadHistory();
    
    // تنظیم اینتروال برای آپدیت خودکار هر ۵ ثانیه
    setInterval(updateDashboard, 5000);

    // افزودن رویداد کلیک به دکمه پمپ
    const btn = document.getElementById("pumpToggle");
    if (btn) {
      btn.addEventListener("click", togglePump);
    }
  });
</script>
